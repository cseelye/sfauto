#!/bin/bash
set -eu

# You can export SFDOCKER_RUN_OPTIONS in your environment to add additional options to the docker run command
# https://docs.docker.com/engine/reference/commandline/run/
SFDOCKER_RUN_OPTIONS=${SFDOCKER_RUN_OPTIONS:-}

# Create the container image if it does not exist
if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q sfauto; then
    echo
    echo "======================================="
    echo "    One-time build SFAUTO docker image"
    echo "======================================="
    echo
    echo
    docker build --force-rm --tag sfauto .
    echo "Finished building sfauto docker image"
    echo
fi

# If the user did not supply a command to run, start the container with an interactive shell
if [[ $# -le 0 ]]; then
    echo
    echo "======================================="
    echo " Entering SFAUTO docker container"
    echo "======================================="
    echo
    cmd="/bin/bash"

# If the user specified a command, run that command in the container
else
    cmd="$*"
fi

index=$(docker ps --format '{{.Names}}' | grep sfauto | cut -d- -f3 | sort | tail)
(( index++ )) || true

# Save the SF* variables into a file to import them into the container
env | grep "^SF" | sort > /tmp/sfauto-env

# Start the container.  To make it as seamless as possible:
#   Run in privileged mode so the user has max power
#   Use the SF* env variables from the current environment in the container
#   Mount this script's directory (assumed to be the sfauto repo directory) into the container
#   Mount the current user's .bashrc and .vimrc into the container so they get the same environment
SFAUTO_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
eval HOMEDIR="~"
BASHRC="${HOMEDIR}/.bashrc"
[[ -e ${BASHRC} ]] && BASHRC_VOLUME="--volume ${BASHRC}:/root/.bashrc" || BASHRC_VOLUME=""
VIMRC="${HOMEDIR}/.vimrc"
[[ -e ${VIMRC} ]] && VIMRC_VOLUME="--volume ${VIMRC}:/root/.vimrc" || VIMRC_VOLUME=""

docker run \
    --interactive \
    --tty \
    --privileged \
    --rm \
    --env-file /tmp/sfauto-env \
    --volume "${SFAUTO_DIR}":/sfauto \
    ${BASHRC_VOLUME} \
    ${VIMRC_VOLUME} \
    --workdir /sfauto \
    --hostname sfauto-container-${index} \
    --name sfauto-container-${index} \
    ${SFDOCKER_RUN_OPTIONS} \
    sfauto ${cmd}
